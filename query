SELECT
  mr.meeting_id,
  mr.region,
  mr.completed_at,
  t.transcript_available_at,
  ROUND(EXTRACT(EPOCH FROM (t.transcript_available_at - mr.completed_at))/60.0, 2) AS delay_minutes,
  t.retry_count,
  t.processed
FROM public.meeting_records mr
JOIN public.transcripts t
  ON t.meeting_id = mr.meeting_id
WHERE mr.environment = 'prod'
  AND mr.region = 'ANZ'
  AND mr.completed_at >= '2026-02-17'::date
  AND mr.completed_at <  '2026-02-18'::date
  AND t.transcript_available_at IS NOT NULL
ORDER BY delay_minutes DESC
LIMIT 200;


SELECT
  mr.region,
  COUNT(*) AS meetings,
  ROUND(AVG(EXTRACT(EPOCH FROM (t.transcript_available_at - mr.completed_at))/60.0), 2) AS avg_delay_min,
  ROUND(MAX(EXTRACT(EPOCH FROM (t.transcript_available_at - mr.completed_at))/60.0), 2) AS max_delay_min
FROM public.meeting_records mr
JOIN public.transcripts t
  ON t.meeting_id = mr.meeting_id
WHERE mr.environment = 'prod'
  AND mr.completed_at >= '2026-02-17'::date
  AND mr.completed_at <  '2026-02-18'::date
  AND t.transcript_available_at IS NOT NULL
GROUP BY mr.region
ORDER BY max_delay_min DESC;



SELECT
  mr.meeting_id,
  mr.completed_at,
  t.transcript_available_at,
  ROUND(EXTRACT(EPOCH FROM (t.transcript_available_at - mr.completed_at))/60.0, 2) AS delay_minutes,
  t.retry_count
FROM public.meeting_records mr
JOIN public.transcripts t ON t.meeting_id = mr.meeting_id
WHERE mr.environment = 'prod'
  AND mr.region = 'ANZ'
  AND mr.completed_at >= '2026-02-17'::date
  AND mr.completed_at <  '2026-02-18'::date
  AND t.transcript_available_at IS NOT NULL
  AND (t.transcript_available_at - mr.completed_at) > interval '30 minutes'
ORDER BY delay_minutes DESC;


