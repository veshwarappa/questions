SELECT
  mr.meeting_id,
  mr.region,
  mr.environment,
  mr.processing_state,
  mr.created_at,
  mr.payload_submitted_at,
  mr.completed_at,
  t.transcript_available_at,
  t.created_at AS transcript_row_created_at,
  t.last_checked_at,
  t.retry_count,
  t.max_retries,
  EXTRACT(EPOCH FROM (t.transcript_available_at - mr.payload_submitted_at)) / 60.0 AS mins_submit_to_available,
  EXTRACT(EPOCH FROM (t.created_at - t.transcript_available_at)) / 60.0 AS mins_available_to_detected
FROM public.meeting_records mr
JOIN public.transcripts t
  ON t.meeting_id = mr.meeting_id
WHERE mr.environment = 'prod'
  AND mr.region IN ('JP', 'Japan', 'japan')  -- adjust to your actual stored value
  AND mr.payload_submitted_at IS NOT NULL
  AND t.transcript_available_at IS NOT NULL
ORDER BY mins_submit_to_available DESC
LIMIT 50;


SELECT
  t.meeting_id,
  t.transcript_available_at,
  t.created_at AS detected_at,
  t.last_checked_at,
  t.retry_count,
  EXTRACT(EPOCH FROM (t.created_at - t.transcript_available_at)) / 60.0 AS mins_detection_lag
FROM public.transcripts t
WHERE t.transcript_available_at IS NOT NULL
  AND t.created_at IS NOT NULL
  AND (t.created_at - t.transcript_available_at) > INTERVAL '10 minutes'
ORDER BY mins_detection_lag DESC
LIMIT 100;


SELECT
  mr.meeting_id,
  mr.region,
  mr.payload_submitted_at,
  t.transcript_available_at,
  EXTRACT(EPOCH FROM (t.transcript_available_at - mr.payload_submitted_at)) / 60.0 AS mins_upstream_delay,
  t.retry_count,
  t.last_checked_at
FROM public.meeting_records mr
JOIN public.transcripts t ON t.meeting_id = mr.meeting_id
WHERE mr.environment = 'prod'
  AND mr.region IN ('JP', 'Japan', 'japan')
  AND mr.payload_submitted_at IS NOT NULL
  AND t.transcript_available_at IS NOT NULL
  AND (t.transcript_available_at - mr.payload_submitted_at) > INTERVAL '10 minutes'
ORDER BY mins_upstream_delay DESC
LIMIT 100;


SELECT
  CASE
    WHEN retry_count IS NULL THEN 'NULL'
    WHEN retry_count = 0 THEN '0'
    WHEN retry_count BETWEEN 1 AND 2 THEN '1-2'
    WHEN retry_count BETWEEN 3 AND 5 THEN '3-5'
    ELSE '6+'
  END AS retry_bucket,
  COUNT(*) AS cnt,
  AVG(EXTRACT(EPOCH FROM (transcript_available_at - created_at)) / 60.0) AS avg_mins_available_minus_created,
  AVG(retry_count) AS avg_retry
FROM public.transcripts
WHERE transcript_available_at IS NOT NULL
  AND created_at IS NOT NULL
GROUP BY 1
ORDER BY 1;


SELECT
  mr.meeting_id,
  mr.region,
  mr.processing_state,
  mr.payload_submitted_at,
  mr.completed_at,
  t.processed,
  t.transcript_available_at,
  t.last_checked_at,
  t.retry_count,
  t.max_retries
FROM public.meeting_records mr
LEFT JOIN public.transcripts t
  ON t.meeting_id = mr.meeting_id
WHERE mr.environment = 'prod'
  AND mr.region IN ('JP', 'Japan', 'japan')
  AND mr.completed_at IS NOT NULL
  AND (t.transcript_available_at IS NULL OR t.processed = false)
ORDER BY mr.completed_at DESC
LIMIT 100;


SELECT
  COUNT(*) AS pending_count,
  MIN(last_checked_at) AS oldest_last_checked,
  MAX(last_checked_at) AS newest_last_checked
FROM public.transcripts
WHERE (transcript_available_at IS NULL OR processed = false);


SELECT
  meeting_id,
  processed,
  transcript_available_at,
  last_checked_at,
  retry_count,
  max_retries
FROM public.transcripts
WHERE (transcript_available_at IS NULL OR processed = false)
ORDER BY last_checked_at ASC NULLS FIRST
LIMIT 50;
