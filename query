WITH base AS (
  SELECT
    (to_timestamp(t.meeting_date || ' ' || t.end_time, 'YYYY-MM-DD HH24:MI')
        AT TIME ZONE 'Australia/Sydney')            AS meeting_end_utc,
    (t.transcript_available_at AT TIME ZONE 'UTC') AS transcript_available_utc
  FROM transcripts t
  WHERE t.meeting_date IS NOT NULL
    AND t.end_time IS NOT NULL
    AND t.transcript_available_at IS NOT NULL
)
SELECT
  COUNT(*) AS n,
  ROUND(AVG(EXTRACT(EPOCH FROM (transcript_available_utc - meeting_end_utc))/60.0), 2) AS avg_min,
  ROUND(PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (transcript_available_utc - meeting_end_utc))/60.0), 2) AS p50_min,
  ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY EXTRACT(EPOCH FROM (transcript_available_utc - meeting_end_utc))/60.0), 2) AS p95_min,
  ROUND(MAX(EXTRACT(EPOCH FROM (transcript_available_utc - meeting_end_utc))/60.0), 2) AS max_min
FROM base
WHERE meeting_end_utc >= (NOW() AT TIME ZONE 'UTC') - INTERVAL '7 days';
